<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="This was originally posted on deis.com.
Kelsey Hightower gave a really interesting talk at ContainerSched about how to create your own scheduler using the Kubernetes HTTP API.
The talk was awesome. It&amp;rsquo;s incredible to see what kind of things you can do with a base system as good as Kubernetes.
However, I missed one thing. The example provided by Kelsey was a Go application. Which is the main language used with Kubernetes."><meta name=keywords content=",devops,elixir,scheduler,kubernetes"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://agonzalezro.github.io/posts/elixir-scheduler/><title>Scheduling Your Kubernetes Pods With Elixir :: // Álex Go{,5z}
</title><link rel=stylesheet href=/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Scheduling Your Kubernetes Pods With Elixir"><meta itemprop=description content="This was originally posted on deis.com.
Kelsey Hightower gave a really interesting talk at ContainerSched about how to create your own scheduler using the Kubernetes HTTP API.
The talk was awesome. It’s incredible to see what kind of things you can do with a base system as good as Kubernetes.
However, I missed one thing. The example provided by Kelsey was a Go application. Which is the main language used with Kubernetes."><meta itemprop=datePublished content="2017-01-16T00:00:00+00:00"><meta itemprop=dateModified content="2017-01-16T00:00:00+00:00"><meta itemprop=wordCount content="1156"><meta itemprop=keywords content="Devops,Elixir,Scheduler,Kubernetes"><meta name=twitter:card content="summary"><meta name=twitter:title content="Scheduling Your Kubernetes Pods With Elixir"><meta name=twitter:description content="This was originally posted on deis.com.
Kelsey Hightower gave a really interesting talk at ContainerSched about how to create your own scheduler using the Kubernetes HTTP API.
The talk was awesome. It’s incredible to see what kind of things you can do with a base system as good as Kubernetes.
However, I missed one thing. The example provided by Kelsey was a Go application. Which is the main language used with Kubernetes."><meta property="article:published_time" content="2017-01-16 00:00:00 +0000 UTC"><script async src="https://www.googletagmanager.com/gtag/js?id=363076712"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","363076712")}</script></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark></span><span class=logo__text>// Álex Go{,5z}</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
6 minutes</p></div><article><h1 class=post-title><a href=https://agonzalezro.github.io/posts/elixir-scheduler/>Scheduling Your Kubernetes Pods With Elixir</a></h1><div class=post-content><blockquote><p>This was originally posted on <a href=https://deis.com/blog/2016/scheduling-your-kubernetes-pods-with-elixir/>deis.com</a>.</p></blockquote><p><a href=https://twitter.com/kelseyhightower>Kelsey Hightower</a> gave a really interesting talk at <a href=https://skillsmatter.com/conferences/7208-containersched-2015>ContainerSched</a> about how to create your own scheduler using the Kubernetes HTTP API.</p><p>The talk was awesome. It&rsquo;s incredible to see what kind of things you can do with a base system as good as Kubernetes.</p><p>However, I missed one thing. The <a href=https://github.com/kelseyhightower/scheduler>example</a> provided by Kelsey was a Go application. Which is the main language used with Kubernetes. So, if you look at that code without any context, you might think it&rsquo;s using some kind of Kubernetes internal packages. But it&rsquo;s not! It&rsquo;s a standalone piece of code that happens to make some HTTP calls.</p><p>To illustrate this point, I decided to write my own scheduler, in a different language. In my case, <a href=http://elixir-lang.org/>Elixir</a>, because that&rsquo;s the language I happen to be learning at the moment.</p><p>This post isn&rsquo;t an intro to Elixir, but the code should be easy to follow.</p><p>Also, I&rsquo;m going to use <code>localhost</code> when accessing the Kubernetes API. Why? For simplicity. If we run <code>kubectl proxy</code> on a computer connected to the Kubernetes master, we will not need to deal with authorization, hosts, and so on. The <code>proxy</code> command will do it for us.</p><p>So, let&rsquo;s dive in.</p><h2 id=get-a-list-of-unscheduled-jobs>Get a List of Unscheduled Jobs</h2><p>To start off with, we need a pod for our scheduler to schedule.</p><p>By default, Kubernetes will schedule all your pods. So, we need to create a unscheduled pod and we need to indicate to Kubernetes that we don&rsquo;t want our pod to get scheduled.</p><p>So, create a file called <code>pod.yml</code> and put this inside:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>custom</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>scheduler.alpha.kubernetes.io/name</span>: <span style=color:#ae81ff>myOwnScheduler</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;nginx&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;nginx:1.10.0&#34;</span>
</span></span></code></pre></div><p>Notice the <code>scheduler.alpha.kubernetes.io/name</code> annotation we use to specify that our scheduler (that we call <code>myOwnScheduler</code>) will be handling this pod.</p><p>Now, let&rsquo;s create the pod from the definition file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f pod.yml
</span></span></code></pre></div><p>After you&rsquo;ve done this, there will be an unscheduled job waiting for us inside Kubernetes. Why unscheduled? Because our pod says it wants to be scheduled by the <code>myOwnScheduler</code> scheduler, but we&rsquo;ve not created it yet, so Kubernetes can&rsquo;t schedule it.</p><p>So, let&rsquo;s build our scheduler.</p><p>First, our scheduler must be able to grab this unscheduled job from the API.</p><p>Here&rsquo;s the function I wrote to do that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#66d9ef>def</span> unscheduled_pods <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  is_managed_by_us <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>(get_in(&amp;1, [<span style=color:#e6db74>&#34;metadata&#34;</span>, <span style=color:#e6db74>&#34;annotations&#34;</span>, <span style=color:#e6db74>&#34;scheduler.alpha.kubernetes.io/name&#34;</span>]) <span style=color:#f92672>==</span> <span style=color:#a6e22e>@name</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  resp <span style=color:#f92672>=</span> <span style=color:#a6e22e>HTTPoison</span><span style=color:#f92672>.</span>get! <span style=color:#e6db74>&#34;http://127.0.0.1:8001/api/v1/pods?fieldSelector=spec.nodeName=&#34;</span>
</span></span><span style=display:flex><span>  resp<span style=color:#f92672>.</span>body
</span></span><span style=display:flex><span>  <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Poison</span><span style=color:#f92672>.</span>decode!
</span></span><span style=display:flex><span>  <span style=color:#f92672>|&gt;</span> get_in([<span style=color:#e6db74>&#34;items&#34;</span>])
</span></span><span style=display:flex><span>  <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>filter(is_managed_by_us)
</span></span><span style=display:flex><span>  <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>map(<span style=color:#f92672>&amp;</span>(get_in(&amp;1, [<span style=color:#e6db74>&#34;metadata&#34;</span>, <span style=color:#e6db74>&#34;name&#34;</span>])))
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>As you can see we are using <code>127.0.0.1</code> to query our API, this is posible thanks to the <code>kubectl proxy</code> command we mentioned in the intro.</p><p>This code grabs the name of all the pods that are waiting to be scheduled inside Kubernetes. It then uses the <code>is_managed_by_us</code> function to see whether the <code>@name</code> attribute is set to <code>myOwnScheduler</code>. If this is true, the pod has indicated that it should be managed by our scheduler.</p><h2 id=an-elixir-introduction>An Elixir Introduction</h2><p>I said I wouldn&rsquo;t explain Elixir, but I will just comment on three piece of syntax.</p><p>The <code>|></code> in the code above is a pipe, like the <code>|</code> character from a shell script. Using this passes the result from the left side as a parameter to the function on the right side. In this way return values can be piped through functions.</p><p>The <code>&</code> character marks an <a href=https://en.wikipedia.org/wiki/Anonymous_function>anonymous function</a>, i.e. a function that we define inline as an expression. And <code>&amp;1</code> refers the first parameter received by the function.</p><p>We can also use an anonymous function as parameter to another function. As we are doing, in the <code>map</code> call.</p><h2 id=get-a-list-of-available-nodes>Get a List of Available Nodes</h2><p>Our <code>unscheduled_pods</code> function gets us a list of pods that have not been scheduled yet. So next up, we can bind them to our nodes. That is, we tell our containers to run on particular nodes.</p><p>But wait, how do we know what nodes are available?</p><p>We&rsquo;ll need to grab those as well, like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#66d9ef>def</span> nodes <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  resp <span style=color:#f92672>=</span> <span style=color:#a6e22e>HTTPoison</span><span style=color:#f92672>.</span>get! <span style=color:#e6db74>&#34;http://127.0.0.1:8001/api/v1/nodes&#34;</span>
</span></span><span style=display:flex><span>  resp<span style=color:#f92672>.</span>body
</span></span><span style=display:flex><span>  <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Poison</span><span style=color:#f92672>.</span>decode!
</span></span><span style=display:flex><span>  <span style=color:#f92672>|&gt;</span> get_in([<span style=color:#e6db74>&#34;items&#34;</span>])
</span></span><span style=display:flex><span>  <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>map(<span style=color:#f92672>&amp;</span>(get_in(&amp;1, [<span style=color:#e6db74>&#34;metadata&#34;</span>, <span style=color:#e6db74>&#34;name&#34;</span>])))
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>This code will return a list of all nodes.</p><p>We could potentially request a lot more information from the API at this point, but for what we&rsquo;re building, it&rsquo;s not necessary. If you want to now what extra information is available, <a href=http://kubernetes.io/kubernetes/third_party/swagger-ui/#!/api%2Fv1/listNamespacedNode>check the documentation for this endpoint</a>.</p><h2 id=the-bind-function>The Bind Function</h2><p>So let&rsquo;s review.</p><p>We have a list of all the unscheduled jobs that we are supposed to manage. And we have a list of all the nodes we can schedule jobs to.</p><p>But how do we actually schedule a pods on a node?</p><p>We call the bind endpoint, like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#66d9ef>def</span> bind(pod_name, node_name) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://127.0.0.1:8001/api/v1/namespaces/default/pods/</span><span style=color:#e6db74>#{</span>pod<span style=color:#e6db74>}</span><span style=color:#e6db74>/binding&#34;</span>
</span></span><span style=display:flex><span>  payload <span style=color:#f92672>=</span> %{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;apiVersion&#34;</span>: <span style=color:#e6db74>&#34;v1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;kind&#34;</span>: <span style=color:#e6db74>&#34;Binding&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;metadata&#34;</span>: %{
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;name&#34;</span>: pod_name,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;target&#34;</span>: %{
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;apiVersion&#34;</span>: <span style=color:#e6db74>&#34;v1&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;kind&#34;</span>: <span style=color:#e6db74>&#34;Node&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;name&#34;</span>: node_name,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  headers <span style=color:#f92672>=</span> [{<span style=color:#e6db74>&#39;content-type&#39;</span>, <span style=color:#e6db74>&#39;application/json&#39;</span>}]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>HTTPoison</span><span style=color:#f92672>.</span>post! url, payload <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Poison</span><span style=color:#f92672>.</span>encode!, headers
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>IO</span><span style=color:#f92672>.</span>puts <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>pod_name<span style=color:#e6db74>}</span><span style=color:#e6db74> pod scheduled in </span><span style=color:#e6db74>#{</span>node_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>But before we can use this function, we need a scheduling strategy.</p><h2 id=scheduling-strategy>Scheduling Strategy</h2><p>For our simple scheduler, we will go with a random scheduling strategy.</p><p>In effect, we schedule each pod on a random node. Multiple pods might even end up on the same node.</p><p>Here&rsquo;s how we do that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#66d9ef>def</span> schedule(pods) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  pods
</span></span><span style=display:flex><span>  <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>each(<span style=color:#f92672>&amp;</span>(bind(&amp;1, <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>random(nodes))))
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Of course, this is very basic, and there are much better ways to maximise the resources we have available to us. But we&rsquo;re building this as a learning exercise. Feel free to extend this code if you want to take things further.</p><p>Some ideas to get you going:</p><ul><li><a href=https://en.wikipedia.org/wiki/Round-robin_scheduling>Round-robin</a> pod scheduling.</li><li>Implement your own version of Kubernete&rsquo;s load-aware scheduling.</li><li>Annotate the pods with some extra information, for example: cluster.type: raspberry if you want to send them to the Raspberry Pi nodes in your cluster.</li><li>You could use some external source of truth, e.g. Nagios, to determine which nodes to schedule jobs on.</li></ul><h2 id=putting-everything-together>Putting Everything Together</h2><p>Now we have everything in place, a <code>main</code> function is all that&rsquo;s needed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#66d9ef>def</span> main(_args) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  unscheduled_pods
</span></span><span style=display:flex><span>  <span style=color:#f92672>|&gt;</span> schedule
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Now you are able to run your program!</p><p>A simple <code>elixir your_script.exs</code> should do it, if you have all the dependencies. But you probably don&rsquo;t, so I recommend you follow the Usage section in <a href=https://github.com/agonzalezro/escheduler#usage>the README</a> for the code that accompanies this post.</p><h2 id=wrap-up>Wrap Up</h2><p>For a most things, you probably don&rsquo;t want to write your own scheduler. The one provided by Kubernetes is good for so many things.</p><p>But if you want to do something the default Kubernetes scheduler can&rsquo;t do, it&rsquo;s not as difficult as you might think to write your own and slot it in, and continue to take advantage of everything Kubernetes has to offer.</p><p>I&rsquo;ve put my code up for <a href=https://github.com/agonzalezro/escheduler>my Elixir scheduler</a>, on GitHub in case you want to check it out. This repository has everything you need to follow along with this post, from the YAML pod definition to the scheduler itself.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://agonzalezro.github.io/tags/devops/>devops</a></span>
<span class=tag><a href=https://agonzalezro.github.io/tags/elixir/>elixir</a></span>
<span class=tag><a href=https://agonzalezro.github.io/tags/scheduler/>scheduler</a></span>
<span class=tag><a href=https://agonzalezro.github.io/tags/kubernetes/>kubernetes</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
1156 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2017-01-16 00:00</p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.85fad2de4f13fec3bcb3b3cb10430cdb44a7b4a9749b32938241a5c6e77718df7624f1002b880521fdc26e24ec1077fda214bf1cb36ee3045510760d09638cae.js integrity="sha512-hfrS3k8T/sO8s7PLEEMM20SntKl0mzKTgkGlxud3GN92JPEAK4gFIf3CbiTsEHf9ohS/HLNu4wRVEHYNCWOMrg=="></script></body></html>